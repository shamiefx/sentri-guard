

<ion-content [fullscreen]="true" class="page-animate tab3-content ion-padding">

  <div class="header-row">
    <div class="title-block">
      <h2 class="heading">Rekod Bulanan</h2>
      <p class="sub">Ringkasan sesi kerja & durasi</p>
    </div>
    <div class="toggle-block">
      <ion-button size="small" fill="outline" (click)="togglePrev()" class="month-toggle" [disabled]="loading()">
        @if (!showPrev()) { <span>{{ prevMonthLabel() }}</span> } @else { <span>{{ currentMonthLabel() }}</span> }
      </ion-button>
    </div>
  </div>

  @if (loading()) { <div class="loading-panel"><ion-spinner name="crescent"></ion-spinner></div> }
  @if (error()) { <div class="error-panel"><ion-text color="danger">{{ error() }}</ion-text></div> }

  <!-- Active Month Panel -->
  @if (!showPrev()) {
    <section class="month-section" aria-labelledby="current-month-label">
      <div class="month-header surface elevate">
        <div>
          <h3 id="current-month-label" class="month-title">{{ currentMonthLabel() }}</h3>
          <p class="metric-line"><strong>{{ (currentTotalClosedMs()/3600000) | number:'1.1-1' }}</strong> jam ditutup ({{ formatMs(currentTotalClosedMs()) }})</p>
        </div>
        <div class="stat-chip">
          <span>{{ currentDailyTotals().length }} hari rekod</span>
        </div>
      </div>

      @if (currentGrouped().length) {
        <div class="days-grid">
          <div *ngFor="let g of currentGrouped()" class="day-card glass-surface elevate">
            <div class="day-head">
              <h4 class="day-date">{{ g.dateDisplay }}</h4>
              <span class="day-total">{{ formatMs(g.totalMs) }}</span>
            </div>
            <ul class="sessions-list">
              <li *ngFor="let s of g.sessions" class="session-row" [class.active]="!s.punchOut">
                <span class="dot" aria-hidden="true"></span>
                <span class="range">
                  @if (s.punchIn) { {{ s.punchIn?.toDate ? (s.punchIn.toDate() | date:'shortTime') : (s.punchIn | date:'shortTime') }} } -
                  @if (s.punchOut) { {{ s.punchOut?.toDate ? (s.punchOut.toDate() | date:'shortTime') : (s.punchOut | date:'shortTime') }} } @else { <em>Aktif</em> }
                </span>
                <span class="dur">@if (s.punchOut) { {{ formatMs(durationMs(s)) }} } @else { — }</span>
              </li>
            </ul>
          </div>
        </div>
      } @else { <div class="empty"><ion-text>Tiada sesi bulan ini.</ion-text></div> }

    </section>
  }

  <!-- Previous Month Panel -->
  @if (showPrev()) {
    <section class="month-section" aria-labelledby="prev-month-label">
      <div class="month-header surface elevate">
        <div>
          <h3 id="prev-month-label" class="month-title">{{ prevMonthLabel() }}</h3>
          <p class="metric-line"><strong>{{ (prevTotalClosedMs()/3600000) | number:'1.1-1' }}</strong> jam ditutup ({{ formatMs(prevTotalClosedMs()) }})</p>
        </div>
        <div class="stat-chip alt">
          <span>{{ prevDailyTotals().length }} hari rekod</span>
        </div>
      </div>
      @if (prevGrouped().length) {
        <div class="days-grid">
          <div *ngFor="let g of prevGrouped()" class="day-card glass-surface elevate">
            <div class="day-head">
              <h4 class="day-date">{{ g.dateDisplay }}</h4>
              <span class="day-total">{{ formatMs(g.totalMs) }}</span>
            </div>
            <ul class="sessions-list">
              <li *ngFor="let s of g.sessions" class="session-row" [class.active]="!s.punchOut">
                <span class="dot" aria-hidden="true"></span>
                <span class="range">
                  @if (s.punchIn) { {{ s.punchIn?.toDate ? (s.punchIn.toDate() | date:'shortTime') : (s.punchIn | date:'shortTime') }} } -
                  @if (s.punchOut) { {{ s.punchOut?.toDate ? (s.punchOut.toDate() | date:'shortTime') : (s.punchOut | date:'shortTime') }} } @else { <em>Aktif</em> }
                </span>
                <span class="dur">@if (s.punchOut) { {{ formatMs(durationMs(s)) }} } @else { — }</span>
              </li>
            </ul>
          </div>
        </div>
      } @else { <div class="empty"><ion-text>Tiada sesi bulan lepas.</ion-text></div> }

      <div class="daily-totals-card surface">
        <h4 class="section-sub">Jumlah Harian</h4>
        <ion-list lines="none">
          <ion-item *ngFor="let d of prevDailyTotals()" class="daily-row">
            <ion-label>
              <strong>{{ d.dateDisplay }}</strong>
              <p>{{ d.human }} ({{ d.decimal | number:'1.2-2' }} jam)</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </section>
  }

</ion-content>
