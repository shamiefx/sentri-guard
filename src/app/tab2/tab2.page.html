<ion-content class="page-animate">
  <!-- Hero / Active Session Card -->
  <ion-card class="session-hero elevate" [class.closed]="sessionClosed()" aria-labelledby="active-session-heading">
    <ion-card-header class="hero-header">
      <div class="hero-row">
        <div class="hero-meta">
          <h2 class="hero-title" id="active-session-heading">Sesi Aktif</h2>
          <p class="hero-sub" *ngIf="activeSessionId()">ID: {{ activeSessionId() }}</p>
          <p class="hero-sub" *ngIf="!activeSessionId() && !loading()">Tiada sesi. Mulakan di Tab 1.</p>
        </div>
        <div class="state-chip" [class.done]="sessionClosed()" *ngIf="activeSessionId()">
          {{ sessionClosed() ? 'SELESAI' : 'AKTIF' }}
        </div>
      </div>
    </ion-card-header>
    <ion-card-content class="hero-content">
      @if (loading()) { <div class="loading-row"><ion-spinner name="crescent"></ion-spinner><span>Memuat...</span></div> }
      @if (error()) { <div class="error-row"><ion-text color="danger">{{ error() }}</ion-text></div> }
      @if (activeSessionId() && !sessionClosed()) { <div class="actions hero-actions">
        <ion-button class="checkpoint-btn" shape="round" (click)="addCheckpoint()" [disabled]="loading()" aria-label="Rekod checkpoint baharu">
          <ion-icon slot="start" name="flag-outline"></ion-icon>
            @if (!loading()) { <span>Rekod Checkpoint</span> } @else { <ion-spinner name="crescent"></ion-spinner> }
        </ion-button>
      </div> }
      @if (activeSessionId() && sessionClosed()) { <div class="closed-msg">
        <ion-text color="medium">Checkpoint selesai.</ion-text>
        <ion-button size="small" fill="outline" class="history-toggle" (click)="toggleHistory()">{{ showingHistory() ? 'Sembunyi' : 'Lihat' }} Sejarah</ion-button>
      </div> }
    </ion-card-content>
  </ion-card>

  <!-- Checkpoints List -->
  @if (checkpoints().length) { <ion-card class="checkpoints-card elevate">
    <ion-card-header>
      <ion-card-title>Checkpoint <span class="count">({{ checkpoints().length }})</span></ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list lines="inset">
        <ion-item *ngFor="let c of checkpoints(); let i = index">
          <ion-label class="ion-text-wrap">
            <h3>Checkpoint {{ i + 1 }} • {{ c.createdAt | date:'shortTime' }}</h3>
            <p>Lat: {{ c.location.lat | number:'1.5-5' }}, Lng: {{ c.location.lng | number:'1.5-5' }}</p>
            @if (c.photoUrl || c.photoPath) { <div class="photo-wrapper">
              <img [src]="c.photoUrl || ''" alt="Foto checkpoint" class="checkpoint-photo" />
            </div> }
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card> }

  @if (showingHistory()) { <ion-card class="history-card">
    <ion-card-header>
      <ion-card-title>Sesi Terkini</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list lines="none">
        <ion-item *ngFor="let s of recentSessions()" (click)="s.checkpoints?.length ? selectHistorySession(s) : null"
          [disabled]="!(s.checkpoints?.length)" [class.no-checkpoints]="!(s.checkpoints?.length)">
          <ion-label class="ion-text-wrap">
            <h3>
              @if (s.punchIn) { <span>{{ s.punchIn?.toDate ? (s.punchIn.toDate() | date:'shortTime') : (s.punchIn | date:'shortTime') }}</span> } @else { <span>?</span> }
              @if (s.punchOut) { <span> - {{ s.punchOut?.toDate ? (s.punchOut.toDate() | date:'shortTime') : (s.punchOut | date:'shortTime') }}</span> }
              <ion-badge *ngIf="!s.punchOut" color="warning" style="margin-left:6px">Terbuka</ion-badge>
            </h3>
            <p>
              @if (!(s.checkpoints?.length)) { Tiada checkpoint }
              @else { {{ s.checkpoints.length }} checkpoint }
            </p>
          </ion-label>
        </ion-item>
      </ion-list>
      @if (!recentSessions().length && !loading()) { <div><ion-text color="medium">Tiada sejarah.</ion-text></div> }
    </ion-card-content>
  </ion-card> }

  @if (selectedHistorySession()) { <ion-card class="detail-card">
    <ion-card-header>
      <ion-card-title>Butiran Sesi</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text>
        <p>
          <strong>Masuk:</strong>
          @if (selectedHistorySession().punchIn) { <ng-container>
            {{ selectedHistorySession().punchIn?.toDate ? (selectedHistorySession().punchIn.toDate() | date:'short') :
            (selectedHistorySession().punchIn | date:'short') }}
          </ng-container> } @else { — }
        </p>
        <p>
          <strong>Keluar:</strong>
          @if (selectedHistorySession().punchOut) { <ng-container>
            {{ selectedHistorySession().punchOut?.toDate ? (selectedHistorySession().punchOut.toDate() | date:'short') :
            (selectedHistorySession().punchOut | date:'short') }}
          </ng-container> } @else { — }
        </p>
        @if (sessionDurationMs(selectedHistorySession()) > 0) { <p><strong>Tempoh:</strong> {{
          formatMs(sessionDurationMs(selectedHistorySession())) }}</p> }
      </ion-text>
      @if (selectedHistorySession().checkpoints?.length) { <ion-list lines="inset">
        <ion-item *ngFor="let c of selectedHistorySession().checkpoints; let i = index">
          <ion-label class="ion-text-wrap">
            <h3>Checkpoint {{ i + 1 }} • {{ c.createdAt | date:'shortTime' }}</h3>
            <p>Lat: {{ c.location.lat | number:'1.4-4' }}, Lng: {{ c.location.lng | number:'1.4-4' }}</p>
            @if (c.photoUrl) { <img [src]="c.photoUrl" alt="Foto checkpoint" class="checkpoint-photo" /> }
          </ion-label>
        </ion-item>
      </ion-list> } @else { <div><ion-text color="medium">Tiada checkpoint dalam sesi ini.</ion-text></div> }
      <div style="margin-top:12px">
        <ion-button size="small" fill="outline" (click)="closeHistoryDetail()">Tutup</ion-button>
      </div>
    </ion-card-content>
  </ion-card> }
</ion-content>