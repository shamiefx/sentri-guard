<ion-header>
  <ion-toolbar>
    <ion-title>Punch Time</ion-title>
    <ion-buttons slot="end">
      <ion-button size="small" (click)="logout()">Logout</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ punchedIn ? 'Currently Punched In' : 'Ready to Punch In' }}</ion-card-title>
    </ion-card-header>
    
    <ion-card-content>
      <div *ngIf="punchedIn && elapsedDisplay()" class="elapsed">
        <ion-text color="medium">Elapsed: {{ elapsedDisplay() }}</ion-text>
      </div>
      <div *ngIf="message()" class="msg"> <ion-text>{{ message() }}</ion-text></div>
      <ion-button expand="block" color="primary" (click)="punchIn()" *ngIf="!punchedIn" [disabled]="loading()">
        <ng-container *ngIf="!loading(); else inLoad">Punch In</ng-container>
      </ion-button>
  <ion-button expand="block" color="danger" (click)="punchOut()" *ngIf="punchedIn" [disabled]="loading()">
        <ng-container *ngIf="!loading(); else outLoad">Punch Out</ng-container>
      </ion-button>
      <ng-template #inLoad><ion-spinner name="crescent"></ion-spinner></ng-template>
      <ng-template #outLoad><ion-spinner name="crescent"></ion-spinner></ng-template>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Today</ion-card-title>
    </ion-card-header>
    <ion-card-content>
  <ion-text>Total Worked: {{ formatHm(companyWorkedTodayMs()) }} ({{ (companyWorkedTodayMs()/3600000) | number:'1.2-2' }} hrs)</ion-text>
      <div *ngIf="punchedIn && activeStartTime()" style="margin-top:6px;">
        <ion-text color="success">Active since {{ activeStartTime() }} ({{ elapsedDisplay() }})</ion-text>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>My Punches (Today)</ion-card-title>
      <ion-card-subtitle>Filtered from company list</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div *ngIf="!myCompanyTodayPunches().length" class="ion-text-center" style="margin-bottom:8px;">
        <ion-text color="medium">No punches yet today.</ion-text>
      </div>
      <ion-list lines="none">
        <ion-item *ngFor="let r of myCompanyTodayPunches()">
          <ion-label class="ion-text-wrap">
            <h3>
              {{ r.staffId || r.email || (r.userId | slice:0:6) }}
              <ion-badge *ngIf="r.active" color="success" style="margin-left:6px">Active</ion-badge>
            </h3>
            <p>
              In: {{ r.punchIn?.toDate ? (r.punchIn.toDate() | date:'shortTime') : (r.punchIn | date:'shortTime') }}
              &nbsp;–&nbsp;
              Out:
              <ng-container *ngIf="r.punchOut; else activeOut">
                {{ r.punchOut?.toDate ? (r.punchOut.toDate() | date:'shortTime') : (r.punchOut | date:'shortTime') }}
              </ng-container>
              <ng-template #activeOut><strong>—</strong></ng-template>
            </p>
            <p>Duration: {{ formatMs(r.durationMs) }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="offlineTasks() > 0">
    <ion-card-header>
      <ion-card-title>Offline Queue</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text>{{ offlineTasks() }} pending action(s) will sync when online.</ion-text>
      <div class="sync-actions">
        <ion-button size="small" (click)="syncNow()" [disabled]="syncing()">{{ syncing() ? 'Syncing...' : 'Sync Now' }}</ion-button>
      </div>
      <ion-text *ngIf="syncResult()">{{ syncResult() }}</ion-text>
    </ion-card-content>
  </ion-card>

</ion-content>
